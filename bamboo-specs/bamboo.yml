---
version: 2
plan:
  project-key: BCP
  key: PJWTSU
  name: PHP JwtSupport

stages:
  - Test:
      - Build Docker image and test
  - Package:
      - Create Composer package

Build Docker image and test:
  tasks:
    - script: |
        #!/bin/bash

        set -eux

        dockertag="phpjwtsupport-test:${bamboo.planKey}-${bamboo.buildNumber}"
        docker build --tag "$dockertag" .

        rm -rf test-results || true
        mkdir -p test-results
        docker run --rm --name "phpunit-${bamboo.planKey}-${bamboo.buildNumber}" --volume "$PWD/test-results:/test-results" $dockertag
  final-tasks:
    - test-parser:
        type: junit
        test-results: test-results/test-report.xml
    - script: |
        rm -r test-results
  requirements:
    - Docker

Create Composer package:
  tasks:
    - script:
        - apk add git
        - git archive --format=tgz "${bamboo.planRepository.revision}" > phpjwtsupport.tar.gz
  artifacts:
    - name: phpjwtsupport.tar.gz
      location: ./
      pattern: phpjwtsupport.tar.gz
      required: true
      shared: true
  docker: alpine